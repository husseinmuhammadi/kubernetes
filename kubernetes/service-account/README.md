# Service Account
so let's talk about security in kubernetes and service accounts
to access the kubernetes api server you need an authentication token
the processes that are running inside your containers use a service account to authenticate with the Kubernetes API server
just like a user account represents a human a service account represents and provides an identity to your pods
each pod you create has a service account assigned to it even if you don't explicitly provide the service account name
if you don't provide the name kubernetes will set the default service account for your pod
this default service account is called default and it is in every namespace in kubernetes which means that account is bound to the namespace it lives in
you can try creating a new namespace and then listing the service accounts and you'll see there's an account service account called default
so if i create a new namespace and then if i list the service accounts in my new namespace you'll notice that
there's a default service account that has that one secret

and it's only six seconds old so
i'll be using uh minicube so we're gonna start by creating a pot to see where the service account gets specified
so i'm just going to do cubesat run simple simple pod and it's going to use the nginx image
in order to look at the yaml representation of this pod you can use the output flag and then specify yaml
so we're going to do cube ctl git pod simple pod output yaml and let me just grip for service account name
and you'll notice that the service account name is set to default
we haven't explicitly set anything so kubernetes assigned this default service account name to our pod

so let's look at how this service account looks like
so let's do describe service account sa is the short name and the name of the service account is default
so like any other resource the service account has a name namespace and labels and annotations
additionally service account has the image pull secrets, mountable secrets and tokens section

if we defined image pull secrets these are then used by pods to pull the images from private docker registries
kubernetes would automatically add those to all pods that are using this service account
the mountable secrets fields is specifying the secrets that can be mounted by the pods that are using this service account
finally the token the tokens field lists all authentication tokens in the service account
kubernetes also automatically mounts the first token inside the container

let's look at the yammer representation of the service account so we'll do get sa default and output yaml now the mountable secret from the account uh so this would be the default token z559d this gets automatically mounted in each pod under the var run secrets kubernetes io service account uh folder and the secret then stores uh the authentication token that's mounted as a token file namespace name that's mounted as namespace file and then the public certificate authority of the api server let's get mounted as a ca.crt file so let's look at that so let's do exec it simple pod and then we'll do bin sh and then we will look in the var run secrets secrets secrets and kubernetes nadis dot nitties.io and service account folder so we'll have these three files here we'll have the certificate authority the namespace so if we look at the contents it's default and the actual authentication token right now kubernetes uses different authentication mechanisms or plugins so client certificates bearer tokens authenticating proxies or http basic auth to authenticate api requests so whenever the api server receives a request the request then goes through all these configured plugins and then the plugins try to determine the request sender the plugins will try to extract the caller's identity from the request and the first plugin that's able to do that so the first plugin that can extract that information will then send it to the api server now the identity of the caller has multiple parts so it has the username it has the user id so this is the string that identifies the user and it's more unique than just a user name and as a group and group is a set of strings that indicates the groups that a user belongs to so that could be system administrator or developers and then any extra fields now the api server uses this username to then determine if the caller the caller being the process inside the container inside your pod can perform the desired actions for example getting the pods list from the api server now each service account can belong to one or more groups and then these groups are used to grant permissions to multiple users at the same time for example there's a group called administrators that grants the administrative privileges to all accounts that are part of that group and these groups are nothing else but just simple unique strings such as administrators admins developers etc so let's go back to the simple pod so we'll say cube ctl exec id simple pod and then we'll do bin sh and what we'll do here is we'll try to invoke the kubernetes api using the service account token that was mounted inside this container so the first thing that i'll do is i'll just store the token in an environment variable so we'll say secrets dot io service account slash token and let's just make sure that i got the path right okay so it's there um so we'll use this token as the bearer token and then invoke the kubernetes api so previously i think in one of the previous videos when we were listing services let's have a list of services you'll notice that there's the kubernetes service so what we'll do is we'll call the kubernetes api through this kubernetes service so let's do this i'll just say kubernetes sorry curl and then authorization authorization realization is going to be bearer and then we'll paste in our token and we'll just call the kubernetes service and the default namespace on port 443 and we're going to call the api there you go so let's say we wanted to so this is just the route we're calling the uh the the root api that it's saying api versions okay so there's a v1 version of the api so the next call that we could make and i'm just gonna copy paste this this uh oh it's not gonna work i guess i'll have to type it so let's just type the same thing authoritorization bearer token https kubernetes dot default 443 api v1 so this would be uh the v1 version of the api and this is telling us that there's all the different apis and uh uh that correspond to the resources uh in the cluster right so this gives us that list now let's say if we wanted to access uh or get the information about our simple pod specifically so let's do curl ssk h authorization bearer token token and then we'll do https kubernetes kubernetes.default 443 api v1 so we'll say namespaces default namespace we want the pods and we specifically want the simplepod so there you go notice that the message that we got back is saying the pod simplepod because that's the identity that's the token that we used it's saying that the user system service account default default so note the first default in the name is the namespace name and the second one is the service account name so what it's saying is that this user cannot get the bots from the default namespace what we could do is we could add this default service account to a group that has more permissions however that would be a horrible idea because remember the default service account gets added and automatically assigned to each pod if the pod does not specify its service account now a much better practice is to create a new service account and then explicitly set it for that pod so let's do exit here and clean up and then we'll see how we can do that so delete the spot there we go - Generated with https://kome.ai
